<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flexible Schedule Builder V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useCallback, useEffect } = React;

        // --- Helper Functions ---
        // Converts 24-hour time (HH:MM) to 12-hour AM/PM format
        const convertToAmPm = (time24) => {
            if (!time24) return 'N/A';
            const [hours, minutes] = time24.split(':');
            let h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; 
            const minutesStr = minutes < 10 ? '0' + minutes : minutes;
            return `${h}:${minutesStr} ${ampm}`;
        };
        // Converts 24-hour time (HH:MM) to minutes from midnight
        const timeToMinutes = (time24) => {
            if (!time24) return 0;
            const [hours, minutes] = time24.split(':').map(Number);
            return hours * 60 + minutes;
        };
        // Parses the start time from the schedule slot string (e.g., '10:30 AM-11:00 AM') to minutes
        const parseScheduleTimeStart = (timeStr) => {
            const parts = timeStr.split('-')[0].trim().split(' ');
            if (parts.length < 2) return 0;
            
            let [time, modifier] = parts;
            let [h, m] = time.split(':').map(Number);

            if (modifier === 'PM' && h !== 12) { h += 12; } 
            else if (modifier === 'AM' && h === 12) { h = 0; }
            
            return h * 60 + m;
        };

        // --- Core Static Data Generation (30-minute intervals) ---
        const TIME_SLOTS = [];
        let timeIdCounter = 1;
        
        // Generate 30-minute blocks from 5:00 AM (05:00) up to 11:30 PM (23:30)
        for (let h = 5; h <= 23; h++) {
            for (let m = 0; m < 60; m += 30) {
                // Stop at 11:30 PM (23:30) for the consistent 30-min blocks
                if (h === 23 && m === 30) break;
                
                const start = new Date(2000, 0, 1, h, m);
                const end = new Date(2000, 0, 1, h, m + 30);
                
                const formatTime = (date) => {
                    let hours = date.getHours();
                    const minutes = date.getMinutes();
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; 
                    const minutesStr = minutes < 10 ? '0' + minutes : minutes;
                    return `${hours}:${minutesStr} ${ampm}`;
                };

                const timeStr = `${formatTime(start)}-${formatTime(end)}`;
                // NOTE: Removing hardcoded prayer assignments from TIME_SLOTS
                const slot = { id: `t${String(timeIdCounter).padStart(2, '0')}`, time: timeStr };

                TIME_SLOTS.push(slot);
                timeIdCounter++;
            }
        }
        
        // Add the final 15-minute slot (11:30 PM - 11:45 PM)
        TIME_SLOTS.push({ 
            id: `t${String(timeIdCounter).padStart(2, '0')}`, 
            time: `${convertToAmPm('23:30')}-${convertToAmPm('23:45')}`, 
            isEnd: true
        });


        const DAYS = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const UNI_DAYS = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];

        // Built-in Tasks (Simplified)
        const BASE_TASK_DEFINITIONS = {
            'none': { id: 'none', name: '— Choose Activity —', category: 'General', color: 'bg-white', text: 'text-gray-500', isEditable: false },
            'wake': { id: 'wake', name: 'Wake Up', category: 'General', color: 'bg-green-300', text: 'text-green-900', isEditable: false },
            'sleep': { id: 'sleep', name: 'Sleep', category: 'General', color: 'bg-gray-800', text: 'text-white', isEditable: false },
            'workout_routine': { id: 'workout_routine', name: 'Workout (Routine)', category: 'Health', color: 'bg-lime-200', text: 'text-lime-900', isWorkout: true, isEditable: false },
        };
        
        // Initial Assignments (Nested structure for weekly assignments: Day -> Slot -> Task)
        const INITIAL_WEEKLY_ASSIGNMENTS = DAYS.reduce((dayAcc, day) => {
            dayAcc[day] = TIME_SLOTS.reduce((slotAcc, slot) => {
                let taskId = 'none';
                if (slot.id === 't01') taskId = 'wake'; 
                if (slot.isEnd) taskId = 'sleep';
                slotAcc[slot.id] = taskId;
                return slotAcc;
            }, {});
            return dayAcc;
        }, {});

        // Workout Routines (unchanged)
        const WORKOUT_ROUTINES = {
          'Sunday': { focus: 'Full Body Strength', exercises: ['Squats (3x12)', 'Push-ups (3x to failure)', 'Dumbbell Rows (3x15)', 'Lunges (3x10)', 'Plank (3x60s)'] },
          'Monday': { focus: 'Cardio & Core HIIT', exercises: ['High Knees (30s)', 'Burpees (30s)', 'Mountain Climbers (30s)', 'Jumping Jacks (30s)', 'Russian Twists (3x20)'] },
          'Tuesday': { focus: 'Lower Body Focus', exercises: ['Glute Bridges (3x20)', 'Single-Leg Deadlifts (3x10)', 'Wall Sit (3x60s)', 'Calf Raises (3x25)'] },
          'Wednesday': { focus: 'Quick Core & Mobility', exercises: ['Cat-Cow Stretch', 'Reverse Crunches (3x15)', 'Side Plank (2x30s)', 'Spine Twist'] },
          'Thursday': { focus: 'Upper Body Focus', exercises: ['Pike Push-ups (3x10)', 'Incline Push-ups (3x to failure)', 'Triceps Dips (3x15)', 'Arm Circles'] },
          'Friday': { focus: 'Active Recovery & Flexibility', exercises: ['30-minute Yin Yoga', 'Deep Hip Flexor Stretch', 'Pigeon Pose', 'Foam Rolling', 'Meditation (10 mins)'] },
          'Saturday': { focus: 'Full Body Endurance Circuit', exercises: ['Jump Squats (45s)', 'Standard Push-ups (45s)', 'Bicycle Crunches (45s)', 'Flutter Kicks (45s)', 'Plank with Shoulder Taps (45s)', 'Repeat 3-4 times.'] },
        };


        // --- Shared Components ---

        const WorkoutModal = ({ workout, onClose }) => { 
            if (!workout) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 print:hidden">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-100">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">{workout.day} Workout</h2>
                        <p className="text-lg font-medium text-teal-600 mb-4 border-b pb-2">Focus: {workout.focus}</p>
                        <ul className="space-y-3 max-h-72 overflow-y-auto pr-2">
                            {workout.exercises.map((ex, index) => (
                                <li key={index} className="flex items-start text-gray-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500 flex-shrink-0 mt-1 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                    </svg>
                                    {ex}
                                </li>
                            ))}
                        </ul>
                        <button
                            onClick={onClose}
                            className="mt-6 w-full py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl transition duration-200 shadow-lg"
                        >
                            Close
                        </button>
                    </div>
                </div>
            );
        };


        // --- VIEW 1: Settings and Task Management ---

        const SettingsView = ({ namajTimes, onNamajTimeChange, uniTimes, onUniTimeChange, customTasks, onAddTask, onDeleteTask, onSwitchView }) => {
            const prayers = ['Fajr', 'Zuhr', 'Asr', 'Maghrib', 'Isha'];
            const [newTaskName, setNewTaskName] = useState('');
            const [newTaskColor, setNewTaskColor] = useState('bg-yellow-100');

            const handleAddTask = () => {
                if (newTaskName.trim() === '') return;
                onAddTask(newTaskName.trim(), newTaskColor);
                setNewTaskName('');
            };

            const TaskDisplay = ({ task, onDelete }) => (
                <div className={`${task.color} ${task.text} p-2 rounded-lg flex justify-between items-center border border-gray-300 shadow-sm`}>
                    <span className="font-semibold text-sm">{task.name}</span>
                    {task.isEditable && (
                        <button onClick={() => onDelete(task.id)} className="text-red-600 hover:text-red-800 transition duration-100 p-1 rounded-full hover:bg-white/50">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clipRule="evenodd" />
                            </svg>
                        </button>
                    )}
                </div>
            );

            return (
                <div className="p-6 space-y-8">
                    <button
                        onClick={() => onSwitchView('schedule')}
                        className="w-full py-3 bg-teal-500 hover:bg-teal-600 text-white text-xl font-bold rounded-xl shadow-lg transition duration-200"
                    >
                        Go to Schedule View →
                    </button>
                    
                    {/* Namaj Times Section */}
                    <div>
                        <h3 className="text-xl font-bold text-center text-indigo-800 mb-4 border-b pb-2">🕌 Namaj Time</h3>
                        <p className="text-center text-sm text-indigo-700 mb-4">Select the specific time for each prayer. This determines the time slot for the indigo border.</p>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                            {prayers.map(prayer => (
                                <div key={prayer} className="flex flex-col">
                                    <label htmlFor={prayer} className="text-sm font-medium text-indigo-700 mb-1">{prayer}</label>
                                    <input
                                        id={prayer}
                                        type="time"
                                        value={namajTimes[prayer]}
                                        onChange={(e) => onNamajTimeChange(prayer, e.target.value)}
                                        className="px-3 py-2 border border-indigo-300 rounded-lg shadow-sm text-gray-900"
                                    />
                                </div>
                            ))}
                        </div>
                        
                        <h3 className="text-xl font-bold text-red-800 mb-4 border-b pb-2">🎓 University/Out-of-Home Blocks (Sat-Thu)</h3>
                        <p className="text-sm text-red-700 mb-4">Set specific start and end times for the days you are out. **Toggle off** a day to omit the block entirely.</p>
                        <div className="space-y-3">
                            {UNI_DAYS.map(day => (
                                <div 
                                    key={day} 
                                    className={`grid grid-cols-1 sm:grid-cols-5 gap-3 sm:gap-4 items-center p-3 rounded-xl shadow-inner border transition-colors ${uniTimes[day]?.isEnabled ? 'bg-red-50/70 border-red-200' : 'bg-gray-100 border-gray-300'}`}
                                >
                                    {/* Day Label and Toggle Switch */}
                                    <div className="sm:col-span-1 flex items-center justify-between sm:block">
                                        <label className={`text-sm font-bold ${uniTimes[day]?.isEnabled ? 'text-red-800' : 'text-gray-500'}`}>{day}</label>
                                        <label className="relative inline-flex items-center cursor-pointer mt-1 sm:mt-0">
                                            <input 
                                                type="checkbox" 
                                                checked={uniTimes[day]?.isEnabled || false} 
                                                onChange={(e) => onUniTimeChange(day, 'isEnabled', e.target.checked)} 
                                                className="sr-only peer"
                                            />
                                            {/* Toggle Switch UI */}
                                            <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                                            <span className={`ms-3 text-sm font-medium hidden sm:inline ${uniTimes[day]?.isEnabled ? 'text-red-700' : 'text-gray-500'}`}>
                                                {uniTimes[day]?.isEnabled ? 'Enabled' : 'Disabled'}
                                            </span>
                                        </label>
                                    </div>
                                    
                                    {/* Start Time Input */}
                                    <div className="col-span-2 flex flex-col">
                                        <label className={`text-xs mb-1 ${uniTimes[day]?.isEnabled ? 'text-red-700' : 'text-gray-500'}`}>Start</label>
                                        <input
                                            type="time"
                                            value={uniTimes[day]?.start || ''}
                                            onChange={(e) => onUniTimeChange(day, 'start', e.target.value)}
                                            className="px-2 py-1 border rounded-lg shadow-sm text-gray-900 text-sm disabled:bg-gray-200 disabled:border-gray-300"
                                            disabled={!uniTimes[day]?.isEnabled}
                                        />
                                    </div>
                                    
                                    {/* End Time Input */}
                                    <div className="col-span-2 flex flex-col">
                                        <label className={`text-xs mb-1 ${uniTimes[day]?.isEnabled ? 'text-red-700' : 'text-gray-500'}`}>End</label>
                                        <input
                                            type="time"
                                            value={uniTimes[day]?.end || ''}
                                            onChange={(e) => onUniTimeChange(day, 'end', e.target.value)}
                                            className="px-2 py-1 border rounded-lg shadow-sm text-gray-900 text-sm disabled:bg-gray-200 disabled:border-gray-300"
                                            disabled={!uniTimes[day]?.isEnabled}
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Task Management Section */}
                    <div>
                        <h3 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">📝 Custom Task Library</h3>
                        <p className="text-sm text-gray-600 mb-4">Add tasks here to make them available in the schedule dropdowns.</p>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Add New Task */}
                            <div className="p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-md">
                                <h4 className="font-bold text-gray-700 mb-2">Add New Task</h4>
                                <input
                                    type="text"
                                    placeholder="Task Name (e.g., Study for Math)"
                                    value={newTaskName}
                                    onChange={(e) => setNewTaskName(e.target.value)}
                                    className="w-full px-3 py-2 mb-2 border rounded-lg focus:ring-teal-500 focus:border-teal-500"
                                />
                                <div className="flex items-center space-x-2 mb-3">
                                    <label className="text-sm">Highlight Color:</label>
                                    <select
                                        value={newTaskColor}
                                        onChange={(e) => setNewTaskColor(e.target.value)}
                                        className="px-2 py-1 border rounded-lg"
                                    >
                                        <option value="bg-yellow-100">Yellow (General)</option>
                                        <option value="bg-indigo-100">Indigo (Study)</option>
                                        <option value="bg-green-100">Green (Health)</option>
                                        <option value="bg-pink-100">Pink (Hobby)</option>
                                    </select>
                                </div>
                                <button
                                    onClick={handleAddTask}
                                    className="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg transition duration-200"
                                >
                                    Add Task
                                </button>
                            </div>

                            {/* Current Tasks List */}
                            <div className="space-y-2 max-h-96 overflow-y-auto p-2">
                                <h4 className="font-bold text-gray-700 mb-2">Your Custom Tasks:</h4>
                                {Object.values(customTasks).length === 0 ? (
                                    <p className="text-sm text-gray-500 italic">No custom tasks added yet.</p>
                                ) : (
                                    Object.values(customTasks).map(task => (
                                        <TaskDisplay key={task.id} task={task} onDelete={onDeleteTask} />
                                    ))
                                )}
                                <h4 className="font-bold text-gray-700 pt-4 border-t mt-4">Built-in Tasks:</h4>
                                <div className="space-y-2">
                                    {Object.values(BASE_TASK_DEFINITIONS).filter(t => t.name !== '— Choose Activity —').map(task => (
                                        <TaskDisplay key={task.id} task={task} onDelete={onDeleteTask} />
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // --- VIEW 2: Schedule Builder ---

        const ScheduleView = ({ allTasks, namajTimes, uniTimes, weeklyAssignments, onAssignmentChange, onShowWorkout, onSwitchView }) => {
            const [isGrouped, setIsGrouped] = useState(true); // NEW: State to toggle grouping

            // Checks if a given schedule slot falls within the user-defined Uni/Out-of-Home block for that day
            const isUniBlockActive = useCallback((scheduleTimeRange, day) => {
                const uniDayTimings = uniTimes[day];
                // Check if the day is a uni day AND if the block is explicitly enabled for that day
                if (!UNI_DAYS.includes(day) || !uniDayTimings || !uniDayTimings.isEnabled || !uniDayTimings.start || !uniDayTimings.end) return false;
                
                const uniStartMinutes = timeToMinutes(uniDayTimings.start);
                const uniEndMinutes = timeToMinutes(uniDayTimings.end);
                const startMinutes = parseScheduleTimeStart(scheduleTimeRange);

                // Handle cases where end time is before start time (e.g., crossing midnight)
                if (uniEndMinutes < uniStartMinutes) {
                    return startMinutes >= uniStartMinutes || startMinutes < uniEndMinutes;
                } else {
                    return startMinutes >= uniStartMinutes && startMinutes < uniEndMinutes;
                }
            }, [uniTimes]);

            // Dynamically check if the current slot's start time matches a user-defined prayer time
            const getPrayerForSlot = useCallback((slot) => {
                const slotStartMinutes = parseScheduleTimeStart(slot.time);

                // Find a prayer where the user's defined time (in minutes) matches the slot's start time (in minutes)
                const matchingPrayer = Object.keys(namajTimes).find(prayer => {
                    return timeToMinutes(namajTimes[prayer]) === slotStartMinutes;
                });

                return matchingPrayer || null; // Returns prayer name (e.g., 'Maghrib') or null
            }, [namajTimes]);

            // NEW: Helper function to determine if a slot is reserved
            const getIsReserved = useCallback((slot, day) => {
                return isUniBlockActive(slot.time, day) || !!getPrayerForSlot(slot);
            }, [isUniBlockActive, getPrayerForSlot]);

            // NEW: Memoized calculation for row spans
            const rowSpans = useMemo(() => {
                const spans = {};
                DAYS.forEach(day => {
                    spans[day] = {};
                    if (!weeklyAssignments[day]) return;
                    let i = 0;
                    while (i < TIME_SLOTS.length) {
                        const startSlot = TIME_SLOTS[i];
                        const startTaskId = weeklyAssignments[day][startSlot.id];
                        const startIsReserved = getIsReserved(startSlot, day);

                        let span = 1;
                        for (let j = i + 1; j < TIME_SLOTS.length; j++) {
                            const nextSlot = TIME_SLOTS[j];
                            const nextTaskId = weeklyAssignments[day][nextSlot.id];
                            const nextIsReserved = getIsReserved(nextSlot, day);
                            
                            // Group if the task and reservation status are identical
                            if (startTaskId === nextTaskId && startIsReserved === nextIsReserved) {
                                span++;
                            } else {
                                break;
                            }
                        }
                        
                        spans[day][startSlot.id] = span; // Set span for the first cell
                        for (let k = 1; k < span; k++) { // Mark subsequent cells to be skipped
                            spans[day][TIME_SLOTS[i + k].id] = 0;
                        }
                        i += span;
                    }
                });
                return spans;
            }, [weeklyAssignments, getIsReserved]);


            // Cell component that contains the individual dropdown control and display logic
            const ScheduleCell = ({ day, slot, rowSpan }) => {
                const assignmentId = weeklyAssignments[day]?.[slot.id] || 'none'; // Access specific day's assignment
                const task = allTasks[assignmentId] || allTasks.none;
                const isUniActive = isUniBlockActive(slot.time, day);
                const matchingPrayer = getPrayerForSlot(slot); // Check for dynamic prayer match
                
                // --- Determine if the slot is reserved ---
                const isReserved = isUniActive || !!matchingPrayer;
                
                const getCellClasses = () => {
                    // MODIFIED: Changed h-20 to min-h-[5rem] for better row spanning, added align-top
                    let classes = `p-2 text-xs border-b border-gray-100 min-h-[5rem] align-top relative`;
                    
                    // Base coloring from the selected task
                    if (isReserved) {
                         classes += ' bg-gray-50/70 text-gray-800'; // Neutral background for reserved
                    } else {
                        classes += ` ${task.color} ${task.text}`;
                    }

                    // 1. Dynamic Uni Highlight (Highest Priority)
                    if (isUniActive) {
                        classes += ' bg-red-100/70 text-red-800 font-semibold border-r-4 border-red-400';
                    }
                    // 2. Namaj Highlight (Now dynamic based on user settings)
                    else if (matchingPrayer) {
                        classes += ' border-l-4 border-indigo-400 font-semibold text-indigo-800';
                    }
                    
                    return classes;
                };
                
                return (
                    // MODIFIED: Apply the calculated rowSpan to the table cell
                    <td key={day} className={getCellClasses()} rowSpan={rowSpan > 1 ? rowSpan : undefined}>
                        {/* Dropdown for assignment (Hidden if reserved or printing) */}
                        {!isReserved ? (
                            <select
                                value={assignmentId}
                                onChange={(e) => onAssignmentChange(day, slot.id, e.target.value)}
                                // MODIFIED: Simplified classes and added print:hidden to fix duplication
                                className={`w-full text-sm font-semibold rounded-md border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 p-1 mb-1 ${task.color} ${task.text} print:hidden`}
                            >
                                {Object.entries(allTasks).map(([id, def]) => (
                                    <option key={id} value={id} className={`p-2 ${def.color} ${def.text}`}>
                                        {def.name}
                                    </option>
                                ))}
                            </select>
                        ) : (
                            // Display for reserved slots (Screen-only display of the reserved status)
                            // MODIFIED: Added print:hidden to fix duplication
                            <div className="p-1 mb-1 bg-white/70 rounded-md shadow-sm border border-gray-300 print:hidden">
                                {/* Display Uni/Out block first */}
                                {isUniActive && (
                                    <span className="text-red-700 font-bold text-sm">University/Out</span>
                                )}
                                {/* Display Namaj time on a new line if Uni time is also active */}
                                {matchingPrayer && (
                                    <span className={`text-indigo-700 font-bold text-sm ${isUniActive ? 'block' : ''}`}>
                                        {matchingPrayer} Prayer
                                    </span>
                                )}
                            </div>
                        )}
                        
                        {/* Task Name Display for Printing (This is the correct one for print) */}
                        <span className={`font-semibold text-sm leading-tight mb-1 hidden print:block`}>
                            {/* For reserved slots, display the *actual* reservation name in print */}
                            {isUniActive && <span className="text-red-800 block">University/Out</span>}
                            {matchingPrayer && <span className="text-indigo-800 block">{matchingPrayer} Prayer</span>}
                            
                            {/* Otherwise, display the assigned task name (only if not reserved) */}
                            {(!isUniActive && !matchingPrayer) && task.name}
                        </span>

                        
                        {/* Namaj Time Details (Time shown below label) */}
                        {matchingPrayer && (
                             <p className="mt-1 text-xxs text-indigo-700 font-medium print:text-xs">
                                 {convertToAmPm(namajTimes[matchingPrayer])}
                            </p>
                        )}
                        {/* Uni Time Details (Time shown below label) */}
                        {isUniActive && uniTimes[day] && (
                             <p className="mt-1 text-xxs font-medium print:text-xs">
                                 {uniTimes[day].start ? convertToAmPm(uniTimes[day].start) : ''} - {uniTimes[day].end ? convertToAmPm(uniTimes[day].end) : ''}
                            </p>
                        )}
                        {/* Show Routine button only if it's a workout and not a reserved slot */}
                        {task.isWorkout && !isReserved && (
                            <button
                                onClick={() => onShowWorkout(day)}
                                className="mt-1 px-2 py-0.5 text-xs font-semibold rounded-lg bg-teal-500 hover:bg-teal-600 text-white transition duration-200 shadow-md flex-shrink-0 print:hidden"
                            >
                                Routine
                            </button>
                        )}
                    </td>
                );
            };
            
            const handlePrint = () => {
                window.print();
            };

            return (
                <div className="p-4">
                    <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4 print:hidden">
                        <button
                            onClick={() => onSwitchView('settings')}
                            className="flex-1 py-3 bg-indigo-500 hover:bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg transition duration-200"
                        >
                            ← Back to Settings
                        </button>
                        {/* NEW: Toggle button for grouping */}
                        <button
                            onClick={() => setIsGrouped(!isGrouped)}
                            className="py-3 px-6 bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold rounded-xl shadow-lg transition duration-200"
                        >
                            {isGrouped ? 'Ungroup Activities' : 'Group Activities'}
                        </button>
                        <button
                            onClick={handlePrint}
                            className="py-3 px-6 bg-yellow-500 hover:bg-yellow-600 text-gray-900 text-xl font-bold rounded-xl shadow-lg transition duration-200"
                        >
                            Download Schedule
                        </button>
                    </div>

                    <div className="overflow-x-auto schedule-container rounded-lg shadow-lg" id="schedule-to-print">
                        <table className="w-full text-left table-fixed">
                            <thead className="sticky top-0 bg-gray-100 border-b border-gray-200 shadow-sm">
                                <tr className="print:bg-gray-200">
                                    {/* Time Slot Header (Sticky) */}
                                    <th className="p-3 w-32 text-gray-700 text-sm font-bold sticky left-0 bg-gray-100 z-20 border-r border-gray-200 print:w-40 print:bg-gray-200">Time Slot</th>
                                    
                                    {/* Day Headers */}
                                    {DAYS.map(day => (
                                        <th key={day} className="p-3 text-gray-700 text-sm font-bold w-40 print:w-40 print:text-center">{day}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {/* MODIFIED: Render loop now accounts for grouping */}
                                {TIME_SLOTS.map(slot => (
                                    <tr key={slot.id}>
                                        {/* Time Column (Sticky) */}
                                        <td className="p-3 font-semibold text-gray-900 border-b border-gray-200 sticky left-0 bg-white/90 backdrop-blur-sm z-10 border-r border-gray-200 print:bg-white print:text-sm">{slot.time}</td>
                                        
                                        {/* Daily Assignment Cells */}
                                        {DAYS.map(day => {
                                            const span = isGrouped ? (rowSpans[day]?.[slot.id] ?? 1) : 1;
                                            
                                            // If grouping is on and this cell is part of a group, skip rendering
                                            if (isGrouped && span === 0) return null;

                                            return (
                                                <ScheduleCell 
                                                    key={day}
                                                    day={day}
                                                    slot={slot}
                                                    rowSpan={span}
                                                />
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---

        const ScheduleApp = () => {
            const [currentPage, setCurrentPage] = useState('settings'); 
            const [showWorkout, setShowWorkout] = useState(null);
            const [customTasks, setCustomTasks] = useState({});

            // 1. Initialize State for Settings and Assignments
            // Ensure initial times are in 24-hour format
            const initialNamajTimes = { Fajr: '05:00', Zuhr: '13:00', Asr: '16:30', Maghrib: '18:30', Isha: '21:30' };
            // Ensure every UNI_DAY has a default (disabled) state
            const initialUniTimes = UNI_DAYS.reduce((acc, day) => {
                acc[day] = { start: '09:00', end: '17:00', isEnabled: false };
                return acc;
            }, {});

            const [namajTimes, setNamajTimes] = useState(initialNamajTimes);
            const [uniTimes, setUniTimes] = useState(initialUniTimes);
            const [weeklyAssignments, setWeeklyAssignments] = useState(INITIAL_WEEKLY_ASSIGNMENTS);

            // 2. Combine base tasks and custom tasks into one object for easy lookup
            const allTasks = useMemo(() => ({
                ...BASE_TASK_DEFINITIONS,
                ...customTasks
            }), [customTasks]);

            // 3. Handlers for state updates
            const handleNamajTimeChange = (prayer, time) => {
                setNamajTimes(prev => ({ ...prev, [prayer]: time }));
            };
            
            const handleUniTimeChange = (day, field, value) => {
                setUniTimes(prev => ({
                    ...prev,
                    [day]: { ...prev[day], [field]: value }
                }));
            };

            const handleAssignmentChange = (day, slotId, taskId) => {
                setWeeklyAssignments(prev => ({
                    ...prev,
                    [day]: { ...prev[day], [slotId]: taskId }
                }));
            };

            const handleAddTask = (name, color) => {
                const newId = `custom_${Date.now()}`;
                const textClass = color.includes('yellow') ? 'text-yellow-900' :
                                  color.includes('indigo') ? 'text-indigo-900' :
                                  color.includes('green') ? 'text-green-900' : 'text-pink-900';

                setCustomTasks(prev => ({
                    ...prev,
                    [newId]: { id: newId, name, color, text: textClass, category: 'Custom', isEditable: true }
                }));
            };

            const handleDeleteTask = (taskId) => {
                // First, remove the task from all assignments
                const updatedAssignments = { ...weeklyAssignments };
                DAYS.forEach(day => {
                    Object.keys(updatedAssignments[day]).forEach(slotId => {
                        if (updatedAssignments[day][slotId] === taskId) {
                            updatedAssignments[day][slotId] = 'none'; // Reset to default
                        }
                    });
                });
                setWeeklyAssignments(updatedAssignments);
                
                // Then, remove the task definition itself
                const newCustomTasks = { ...customTasks };
                delete newCustomTasks[taskId];
                setCustomTasks(newCustomTasks);
            };

            return (
                <div className="bg-gray-50 min-h-screen">
                    <h1 className="text-3xl font-extrabold text-center text-gray-800 py-6 bg-white shadow-md print:hidden">
                        🗓️ Flexible Schedule Builder V3
                    </h1>

                    {currentPage === 'settings' && (
                        <SettingsView
                            namajTimes={namajTimes}
                            onNamajTimeChange={handleNamajTimeChange}
                            uniTimes={uniTimes}
                            onUniTimeChange={handleUniTimeChange}
                            customTasks={customTasks}
                            onAddTask={handleAddTask}
                            onDeleteTask={handleDeleteTask}
                            onSwitchView={setCurrentPage}
                        />
                    )}

                    {currentPage === 'schedule' && (
                        <ScheduleView
                            allTasks={allTasks}
                            namajTimes={namajTimes}
                            uniTimes={uniTimes}
                            weeklyAssignments={weeklyAssignments}
                            onAssignmentChange={handleAssignmentChange}
                            onShowWorkout={(day) => setShowWorkout({ day, ...WORKOUT_ROUTINES[day] })}
                            onSwitchView={setCurrentPage}
                        />
                    )}

                    <WorkoutModal workout={showWorkout} onClose={() => setShowWorkout(null)} />
                </div>
            );
        };

        ReactDOM.render(<ScheduleApp />, document.getElementById('root'));
    </script>
</body>
</html>
